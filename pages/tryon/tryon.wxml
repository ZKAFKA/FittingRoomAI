<view class="container">
  <!-- å¼•å¯¼æµ®å±‚ -->
  <view class="guide-overlay" wx:if="{{showGuideOverlay}}">
    <view class="guide-content">
      <view class="guide-header">
        <text class="guide-title">{{langData.tryon.guideTitle || 'ç¤ºä¾‹å›¾ç‰‡'}}</text>
        <view class="guide-close" bindtap="closeGuideOverlay">âœ•</view>
      </view>
      <view class="guide-body">
        <view class="guide-example">
          <view class="photo-container">
            <image class="example-image" src="{{exampleImageUrl}}" wx:if="{{exampleImageUrl}}" />
            <view class="image-loading" wx:else>
          <text>{{langData.common.loading || 'åŠ è½½ä¸­...'}}</text>
        </view>
            <view class="floating-requirements">
              <view class="floating-requirement-item">
                <image class="requirement-check-icon" src="/assets/icons/checkmark.png" />
                <text class="floating-requirement-text">{{langData.tryon.clearFrontPhoto || 'æ¸…æ™°æ­£é¢ç…§'}}</text>
              </view>
              <view class="floating-requirement-item">
                <image class="requirement-check-icon" src="/assets/icons/checkmark.png" />
                <text class="floating-requirement-text">{{langData.tryon.cleanBackground || 'èƒŒæ™¯å¹²å‡€'}}</text>
              </view>
              <view class="floating-requirement-item">
                <image class="requirement-check-icon" src="/assets/icons/checkmark.png" />
                <text class="floating-requirement-text">{{langData.tryon.goodLighting || 'å…‰çº¿å……è¶³'}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view class="guide-footer">
        <view class="action-area">
          <button class="guide-btn" bindtap="startUpload">{{langData.tryon.iKnowStartUpload || 'æˆ‘çŸ¥é“äº†ï¼Œå¼€å§‹ä¸Šä¼ '}}</button>
        </view>
        <view class="checkbox-wrapper" bindtap="toggleDontShowAgain">
          <view class="checkbox-icon {{dontShowAgain ? 'checked' : ''}}">
            <view class="checkbox-check" wx:if="{{dontShowAgain}}">âœ“</view>
          </view>
          <text class="checkbox-label">{{langData.tryon.dontShowAgain || 'ä¸å†æç¤º'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¸Šä¼ å›¾ç‰‡åŒº -->
  <view class="upload-section relative group">
    <view class="upload-area glass-card border border-primary/20" style="cursor: pointer; z-index: 100; {{userImage ? 'height: ' + uploadAreaHeight + 'rpx; aspect-ratio: auto;' : ''}}" catchtap="chooseUserImage">
      <!-- èƒŒæ™¯å›¾ç‰‡ -->
      <view class="upload-background" wx:if="{{!userImage}}">
        <image class="background-image" src="cloud://fittingroom-0g0zcm3w1d2f40c5.6669-fittingroom-0g0zcm3w1d2f40c5-1400377926/system-images/background.png" mode="aspectFill" bindload="onBackgroundImageLoad" binderror="onBackgroundImageError" />
        <view class="background-overlay"></view>
        <!-- ä¸Šä¼ æç¤º -->
        <view class="upload-prompt">
          <view class="camera-icon-container">
            <image class="camera-icon" src="/assets/icons/upload.png" mode="aspectFit" />
          </view>
          <text class="upload-title">{{langData.tryon.uploadYourPhoto || 'ä¸Šä¼ æ‚¨çš„ç…§ç‰‡'}}</text>
          <text class="upload-subtitle">{{langData.tryon.uploadFullBodyHint || 'ä¸Šä¼ å…¨èº«æ­£é¢ç…§ä»¥è·å¾—æœ€ä½³è¯•è¡£æ•ˆæœ'}}</text>
        </view>
      </view>
      <!-- ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ -->
      <image class="user-image" src="{{generatedImage || userImage}}" mode="aspectFill" wx:if="{{userImage || generatedImage}}" catchlongpress="saveTryonResultImage" />
      <!-- é‡æ–°ä¸Šä¼ æŒ‰é’® -->
      <view class="reupload-btn" wx:if="{{generatedImage}}" bindtap="chooseUserImage">
        <image class="reupload-icon" src="/assets/icons/reupload.png" mode="aspectFit"></image>
      </view>
      <!-- èƒŒæ™¯å›¾ç‰‡åŠ è½½çŠ¶æ€ -->
      <view class="background-loading" wx:if="{{!userImage && backgroundImageLoading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">{{langData.common.loading || 'åŠ è½½ä¸­...'}}</text>
      </view>
      <!-- èº«ä½“ä¿¡æ¯æ¡† -->
      <view class="body-info-box" wx:if="{{userImage}}" bindtap="showBodyInfoEditor">
        <text class="body-info-text">{{bodyInfo.height}}cm/{{bodyInfo.weight}}kg {{bodyInfo.gender}}</text>
      </view>
    </view>
    <!-- Decorative Glow -->
    <view class="upload-glow"></view>
  </view>
  <button class="start-tryon-btn" bindtap="startTryon">
      <image class="btn-icon" src="/assets/icons/stars.png" mode="aspectFit"></image>
      <text class="btn-text">{{langData.tryon.startTryon || 'å¼€å§‹è¯•è¡£'}}</text>
    </button>

  <!-- é€‰æ‹©æœè£…åŒº -->
  <view class="cloth-section space-y-4">
    <!-- åˆ†ç±»å¯¼èˆª -->
    <view class="category-nav">
      <view class="category-list">
        <view class="category-item {{activeCategory === 'upper' ? 'active' : ''}}" bindtap="selectCategory" data-category="upper" id="category-upper">
          <text class="category-text">{{langData.tryon.upper || 'ä¸Šè£…'}}</text>
          <view class="category-dot" wx:if="{{selectedItems.upper}}"></view>
        </view>
        <view class="category-item {{activeCategory === 'lower' ? 'active' : ''}}" bindtap="selectCategory" data-category="lower" id="category-lower">
          <text class="category-text">{{langData.tryon.lower || 'ä¸‹è£…'}}</text>
          <view class="category-dot" wx:if="{{selectedItems.lower}}"></view>
        </view>
        <view class="category-item {{activeCategory === 'suit' ? 'active' : ''}}" bindtap="selectCategory" data-category="suit" id="category-suit">
          <text class="category-text">{{langData.tryon.suit || 'å¥—è£…'}}</text>
          <view class="category-dot" wx:if="{{selectedItems.suit}}"></view>
        </view>
        <view class="category-item {{activeCategory === 'shoes' ? 'active' : ''}}" bindtap="selectCategory" data-category="shoes" id="category-shoes">
          <text class="category-text">{{langData.tryon.shoes || 'é‹å¸½'}}</text>
          <view class="category-dot" wx:if="{{selectedItems.shoes}}"></view>
        </view>
        <view class="category-item {{activeCategory === 'accessories' ? 'active' : ''}}" bindtap="selectCategory" data-category="accessories" id="category-accessories">
          <text class="category-text">{{langData.tryon.accessories || 'é¥°å“'}}</text>
          <view class="category-dot" wx:if="{{selectedItems.accessories}}"></view>
        </view>
      </view>
    </view>

    <!-- å›ºå®šå‘¼å¸ç¯æ¨ªçº¿ -->
    <view class="fixed-breathing-line"></view>

    <!-- æœè£…åˆ—è¡¨ -->
      <view class="cloth-list {{isCategoryNavSticky ? 'is-sticky' : ''}}" 
            bindtouchstart="onTouchStart" 
            bindtouchmove="onTouchMove" 
            bindtouchend="onTouchEnd">
        <!-- è¾¹ç¼˜é«˜äº®æç¤º -->
        <view class="edge-hint left-edge {{showLeftEdgeHint ? 'active' : ''}}"></view>
        <view class="edge-hint right-edge {{showRightEdgeHint ? 'active' : ''}}"></view>
        <!-- åŠ è½½çŠ¶æ€ -->
        <view class="loading-state" wx:if="{{loading}}">
          <view class="loading-spinner"></view>
          <text class="loading-text">{{langData.common.loading || 'åŠ è½½ä¸­...'}}</text>
        </view>
        
        <!-- ä¸Šè£… -->
        <view class="category-content" wx:if="{{!loading && activeCategory === 'upper'}}" style="{{!isCategoryNavSticky ? 'height: ' + categoryHeights.upper + 'rpx;' : ''}}" data-category="upper">
          <view class="waterfall-grid">
            <view class="cloth-item add-cloth-item" bindtap="handleAddCloth" data-category="upper">
              <image class="add-cloth-icon" src="/assets/icons/plus.png" mode="aspectFit" />
              <text class="add-cloth-text">{{langData.tryon.addUpper || 'æ·»åŠ ä¸Šè£…'}}</text>
            </view>
            <view class="cloth-item {{selectedItems.upper && selectedItems.upper._id === item._id ? 'selected' : ''}}" wx:for="{{categoryClothes.upper}}" wx:key="_id" data-id="{{_id}}" data-category="upper" bindtap="selectCloth">
              <image class="cloth-image" src="{{item.imageUrl}}" mode="aspectFill" />
              <view class="cloth-info">
                <text class="cloth-category">{{item.categoryName || 'ä¸Šè£…'}}</text>
                <text class="cloth-name">{{item.name}}</text>
              </view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{!categoryClothes.upper || categoryClothes.upper.length === 0}}">
            <text class="empty-icon">ğŸ‘•</text>
            <text class="empty-text">{{langData.tryon.empty || 'ç©ºç©ºå¦‚ä¹Ÿ'}}</text>
            <text class="empty-hint">{{langData.tryon.addClothHint || 'ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®æ·»åŠ è¡£ç‰©'}}</text>
          </view>
        </view>
        
        <!-- ä¸‹è£… -->
        <view class="category-content" wx:if="{{!loading && activeCategory === 'lower'}}" style="{{!isCategoryNavSticky ? 'height: ' + categoryHeights.lower + 'rpx;' : ''}}" data-category="lower">
          <view class="waterfall-grid">
            <view class="cloth-item add-cloth-item" bindtap="handleAddCloth" data-category="lower">
              <image class="add-cloth-icon" src="/assets/icons/plus.png" mode="aspectFit" />
              <text class="add-cloth-text">{{langData.tryon.addLower || 'æ·»åŠ ä¸‹è£…'}}</text>
            </view>
            <view class="cloth-item {{selectedItems.lower && selectedItems.lower._id === item._id ? 'selected' : ''}}" wx:for="{{categoryClothes.lower}}" wx:key="_id" data-id="{{_id}}" data-category="lower" bindtap="selectCloth">
              <image class="cloth-image" src="{{item.imageUrl}}" mode="aspectFill" />
              <view class="cloth-info">
                <text class="cloth-category">{{item.categoryName || 'ä¸‹è£…'}}</text>
                <text class="cloth-name">{{item.name}}</text>
              </view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{!categoryClothes.lower || categoryClothes.lower.length === 0}}">
            <text class="empty-icon">ğŸ‘–</text>
            <text class="empty-text">{{langData.tryon.empty || 'ç©ºç©ºå¦‚ä¹Ÿ'}}</text>
            <text class="empty-hint">{{langData.tryon.addClothHint || 'ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®æ·»åŠ è¡£ç‰©'}}</text>
          </view>
        </view>
        
        <!-- å¥—è£… -->
        <view class="category-content" wx:if="{{!loading && activeCategory === 'suit'}}" style="{{!isCategoryNavSticky ? 'height: ' + categoryHeights.suit + 'rpx;' : ''}}" data-category="suit">
          <view class="waterfall-grid">
            <view class="cloth-item add-cloth-item" bindtap="handleAddCloth" data-category="suit">
              <image class="add-cloth-icon" src="/assets/icons/plus.png" mode="aspectFit" />
              <text class="add-cloth-text">{{langData.tryon.addSuit || 'æ·»åŠ å¥—è£…'}}</text>
            </view>
            <view class="cloth-item {{selectedItems.suit && selectedItems.suit._id === item._id ? 'selected' : ''}}" wx:for="{{categoryClothes.suit}}" wx:key="_id" data-id="{{_id}}" data-category="suit" bindtap="selectCloth">
              <image class="cloth-image" src="{{item.imageUrl}}" mode="aspectFill" />
              <view class="cloth-info">
                <text class="cloth-category">{{item.categoryName || 'å¥—è£…'}}</text>
                <text class="cloth-name">{{item.name}}</text>
              </view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{!categoryClothes.suit || categoryClothes.suit.length === 0}}">
            <text class="empty-icon">ğŸ‘”</text>
            <text class="empty-text">{{langData.tryon.empty || 'ç©ºç©ºå¦‚ä¹Ÿ'}}</text>
            <text class="empty-hint">{{langData.tryon.addClothHint || 'ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®æ·»åŠ è¡£ç‰©'}}</text>
          </view>
        </view>
        
        <!-- é‹å¸½ -->
        <view class="category-content" wx:if="{{!loading && activeCategory === 'shoes'}}" style="{{!isCategoryNavSticky ? 'height: ' + categoryHeights.shoes + 'rpx;' : ''}}" data-category="shoes">
          <view class="waterfall-grid">
            <view class="cloth-item add-cloth-item" bindtap="handleAddCloth" data-category="shoes">
              <image class="add-cloth-icon" src="/assets/icons/plus.png" mode="aspectFit" />
              <text class="add-cloth-text">{{langData.tryon.addShoes || 'æ·»åŠ é‹å¸½'}}</text>
            </view>
            <view class="cloth-item {{selectedItems.shoes && selectedItems.shoes._id === item._id ? 'selected' : ''}}" wx:for="{{categoryClothes.shoes}}" wx:key="_id" data-id="{{_id}}" data-category="shoes" bindtap="selectCloth">
              <image class="cloth-image" src="{{item.imageUrl}}" mode="aspectFill" />
              <view class="cloth-info">
                <text class="cloth-category">{{item.categoryName || 'é‹å¸½'}}</text>
                <text class="cloth-name">{{item.name}}</text>
              </view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{!categoryClothes.shoes || categoryClothes.shoes.length === 0}}">
            <text class="empty-icon">ğŸ‘Ÿ</text>
            <text class="empty-text">{{langData.tryon.empty || 'ç©ºç©ºå¦‚ä¹Ÿ'}}</text>
            <text class="empty-hint">{{langData.tryon.addClothHint || 'ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®æ·»åŠ è¡£ç‰©'}}</text>
          </view>
        </view>
        
        <!-- é¥°å“ -->
        <view class="category-content" wx:if="{{!loading && activeCategory === 'accessories'}}" style="{{!isCategoryNavSticky ? 'height: ' + categoryHeights.accessories + 'rpx;' : ''}}" data-category="accessories">
          <view class="waterfall-grid">
            <view class="cloth-item add-cloth-item" bindtap="handleAddCloth" data-category="accessories">
              <image class="add-cloth-icon" src="/assets/icons/plus.png" mode="aspectFit" />
              <text class="add-cloth-text">{{langData.tryon.addAccessories || 'æ·»åŠ é¥°å“'}}</text>
            </view>
            <view class="cloth-item {{selectedItems.accessories && selectedItems.accessories._id === item._id ? 'selected' : ''}}" wx:for="{{categoryClothes.accessories}}" wx:key="_id" data-id="{{_id}}" data-category="accessories" bindtap="selectCloth">
              <image class="cloth-image" src="{{item.imageUrl}}" mode="aspectFill" />
              <view class="cloth-info">
                <text class="cloth-category">{{item.categoryName || 'é¥°å“'}}</text>
                <text class="cloth-name">{{item.name}}</text>
              </view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{!categoryClothes.accessories || categoryClothes.accessories.length === 0}}">
            <text class="empty-icon">ğŸ“¿</text>
            <text class="empty-text">{{langData.tryon.empty || 'ç©ºç©ºå¦‚ä¹Ÿ'}}</text>
            <text class="empty-hint">{{langData.tryon.addClothHint || 'ç‚¹å‡»å·¦ä¸Šè§’æŒ‰é’®æ·»åŠ è¡£ç‰©'}}</text>
          </view>
        </view>
      </view>
  </view>

  <!-- è¯•è¡£æ•ˆæœå±•ç¤º -->
  <view class="result-section" wx:if="{{generatedImage}}">
    <view class="section-header">
      <text class="section-title">{{langData.tryon.tryonEffect || 'è¯•è¡£æ•ˆæœ'}}</text>
    </view>
    <view class="result-area glass-card">
      <image class="result-image" src="{{generatedImage}}" />
      <view class="result-actions">
        <button class="result-btn" bindtap="saveTryonResult">{{langData.tryon.saveEffect || 'ä¿å­˜æ•ˆæœ'}}</button>
        <button class="result-btn" bindtap="shareTryonResult">{{langData.tryon.shareEffect || 'åˆ†äº«æ•ˆæœ'}}</button>
      </view>
    </view>
  </view>

  <!-- é”™è¯¯æç¤º -->
  <view class="error" wx:if="{{error}}">
    <text class="error-text">{{error}}</text>
    <button class="error-btn" bindtap="handleError">{{langData.common.retry || 'é‡è¯•'}}</button>
  </view>

  <!-- èº«ä½“ä¿¡æ¯ç¼–è¾‘å™¨å¼¹çª— -->
  <body-info-editor 
    visible="{{showBodyInfoEditor}}" 
    height="{{bodyInfo.height}}" 
    weight="{{bodyInfo.weight}}" 
    gender="{{bodyInfo.gender}}"
    bind:confirm="handleBodyInfoConfirm" 
    bind:cancel="hideBodyInfoEditor" 
  />
</view>
