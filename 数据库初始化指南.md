# 数据库初始化指南

## 概述

本文档详细说明如何初始化数据库中的各个集合，包括数据结构、初始化脚本和操作步骤。

---

## 一、users集合（用户信息）

### 数据结构

```javascript
{
  _id: "自动生成",
  openid: "用户OpenID（唯一）",
  nickName: "用户昵称",
  avatarUrl: "头像URL",
  createTime: "创建时间（服务器时间）",
  updateTime: "更新时间（服务器时间）",
  settings: {
    privacyProtection: false,
    backgroundReplace: false,
    imageOptimization: false
  },
  stats: {
    totalTryOn: 0,
    totalShares: 0,
    totalLikes: 0
  }
}
```

### 初始化方式

**方式1：通过login云函数自动创建**

用户首次登录时，login云函数会自动创建用户记录。无需手动初始化。

**方式2：手动创建测试用户**

在云开发控制台手动添加测试用户：

1. 打开云开发控制台 → 数据库 → users集合
2. 点击"添加记录"
3. 输入以下数据：
   ```json
   {
     "openid": "test-user-001",
     "nickName": "测试用户",
     "avatarUrl": "/assets/images/default-avatar.png",
     "createTime": {
       "$date": "2024-01-01T00:00:00.000Z"
     },
     "updateTime": {
       "$date": "2024-01-01T00:00:00.000Z"
     },
     "settings": {
       "privacyProtection": false,
       "backgroundReplace": false,
       "imageOptimization": false
     },
     "stats": {
       "totalTryOn": 0,
       "totalShares": 0,
       "totalLikes": 0
     }
   }
   ```
4. 点击"确定"

---

## 二、body_profile集合（身体档案）

### 数据结构

```javascript
{
  _id: "自动生成",
  openid: "用户OpenID",
  height: 170,
  weight: 65,
  gender: "male",
  bodyType: "标准",
  measurements: {
    chest: 90,
    waist: 75,
    hips: 92,
    shoulder: 42
  },
  preferences: {
    style: "casual",
    colors: ["black", "white", "blue"],
    avoidColors: ["red", "yellow"]
  },
  createTime: "创建时间（服务器时间）",
  updateTime: "更新时间（服务器时间）"
}
```

### 初始化方式

**方式1：用户首次填写身体档案时创建**

用户在"身体档案"页面首次填写时自动创建。

**方式2：手动创建测试数据**

在云开发控制台手动添加测试数据：

1. 打开云开发控制台 → 数据库 → body_profile集合
2. 点击"添加记录"
3. 输入以下数据：
   ```json
   {
     "openid": "test-user-001",
     "height": 175,
     "weight": 70,
     "gender": "male",
     "bodyType": "标准",
     "measurements": {
       "chest": 95,
       "waist": 80,
       "hips": 95,
       "shoulder": 44
     },
     "preferences": {
       "style": "casual",
       "colors": ["black", "white", "blue"],
       "avoidColors": []
     },
     "createTime": {
       "$date": "2024-01-01T00:00:00.000Z"
     },
     "updateTime": {
       "$date": "2024-01-01T00:00:00.000Z"
     }
   }
   ```
4. 点击"确定"

---

## 三、wardrobe集合（服装库）

### 数据结构

```javascript
{
  _id: "自动生成",
  openid: "用户OpenID",
  name: "服装名称",
  category: "服装类别（accessory/upper/inner/lower/shoes/fullset）",
  imageUrl: "图片URL",
  processedImageUrl: "处理后的图片URL",
  color: "颜色",
  style: "风格",
  brand: "品牌",
  season: "季节",
  tags: ["标签1", "标签2"],
  usageCount: 0,
  lastUsedTime: "最后使用时间",
  createTime: "创建时间（服务器时间）",
  updateTime: "更新时间（服务器时间）"
}
```

### 初始化方式

**方式1：用户上传服装时自动创建**

用户在"上传服装"页面上传时自动创建记录。

**方式2：批量导入测试数据**

使用云函数批量导入测试数据：

1. 创建`initWardrobe`云函数
2. 复制以下代码到`index.js`：
   ```javascript
   const cloud = require('wx-server-sdk');
   cloud.init({
     env: cloud.DYNAMIC_CURRENT_ENV
   });

   const db = cloud.database();

   exports.main = async (event, context) => {
     const testClothes = [
       {
         openid: 'test-user-001',
         name: '白色T恤',
         category: 'upper',
         imageUrl: '/assets/images/clothes/white-tshirt.jpg',
         processedImageUrl: '/assets/images/clothes/white-tshirt-processed.jpg',
         color: 'white',
         style: 'casual',
         brand: 'Uniqlo',
         season: 'summer',
         tags: ['基础款', '百搭'],
         usageCount: 0,
         lastUsedTime: null,
         createTime: db.serverDate(),
         updateTime: db.serverDate()
       },
       {
         openid: 'test-user-001',
         name: '黑色牛仔裤',
         category: 'lower',
         imageUrl: '/assets/images/clothes/black-jeans.jpg',
         processedImageUrl: '/assets/images/clothes/black-jeans-processed.jpg',
         color: 'black',
         style: 'casual',
         brand: 'Levis',
         season: 'all',
         tags: ['基础款', '百搭'],
         usageCount: 0,
         lastUsedTime: null,
         createTime: db.serverDate(),
         updateTime: db.serverDate()
       },
       {
         openid: 'test-user-001',
         name: '白色运动鞋',
         category: 'shoes',
         imageUrl: '/assets/images/clothes/white-sneakers.jpg',
         processedImageUrl: '/assets/images/clothes/white-sneakers-processed.jpg',
         color: 'white',
         style: 'sport',
         brand: 'Nike',
         season: 'all',
         tags: ['运动', '舒适'],
         usageCount: 0,
         lastUsedTime: null,
         createTime: db.serverDate(),
         updateTime: db.serverDate()
       }
     ];

     const results = [];
     for (const cloth of testClothes) {
       const result = await db.collection('wardrobe').add({
         data: cloth
       });
       results.push(result._id);
     }

     return {
       success: true,
       count: results.length,
       ids: results
     };
   };
   ```
3. 部署云函数
4. 调用云函数执行初始化

---

## 四、tryon_records集合（试衣记录）

### 数据结构

```javascript
{
  _id: "自动生成",
  openid: "用户OpenID",
  userImageUrl: "用户照片URL",
  resultImageUrl: "试衣结果URL",
  tryonMode: "试衣模式（change/outfit）",
  selectedClothes: [
    {
      _id: "服装ID",
      name: "服装名称",
      category: "类别",
      color: "颜色",
      style: "风格"
    }
  ],
  prompt: "AI提示词",
  settings: {
    privacyProtection: false,
    backgroundReplace: false,
    imageOptimization: false
  },
  bodyProfile: {
    height: 175,
    weight: 70
  },
  generationTime: 15,
  aiOptimized: false,
  createTime: "创建时间（服务器时间）",
  isShared: false
}
```

### 初始化方式

**自动创建**

用户每次试衣后，系统会自动创建试衣记录。无需手动初始化。

---

## 五、inspirations集合（灵感库）

### 数据结构

```javascript
{
  _id: "自动生成",
  openid: "用户OpenID（官方灵感为null）",
  nickName: "用户昵称",
  avatarUrl: "用户头像URL",
  imageUrl: "灵感图片URL",
  description: "描述",
  style: "风格",
  tags: ["标签1", "标签2"],
  clothes: [
    {
      name: "服装名称",
      category: "类别",
      color: "颜色",
      style: "风格"
    }
  ],
  likes: 0,
  likedBy: ["用户OpenID1", "用户OpenID2"],
  views: 0,
  shares: 0,
  isOfficial: false,
  createTime: "创建时间（服务器时间）",
  status: "状态（active/deleted）"
}
```

### 初始化方式

**方式1：用户分享时自动创建**

用户将试衣结果分享到灵感库时自动创建。

**方式2：导入官方灵感数据**

使用云函数批量导入官方灵感数据（详见"官方灵感数据初始化指南"）。

---

## 六、tryon_tasks集合（试衣任务队列）

### 数据结构

```javascript
{
  _id: "自动生成",
  openid: "用户OpenID",
  taskType: "任务类型",
  status: "状态（pending/processing/completed/failed）",
  inputData: {},
  outputData: {},
  errorMessage: "错误信息",
  createTime: "创建时间（服务器时间）",
  updateTime: "更新时间（服务器时间）",
  completedTime: "完成时间（服务器时间）"
}
```

### 初始化方式

**自动创建**

系统在处理试衣任务时自动创建任务记录。无需手动初始化。

---

## 七、数据库清理脚本

### 清空测试数据

创建`cleanDatabase`云函数：

```javascript
const cloud = require('wx-server-sdk');
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  const { confirm } = event;
  
  if (!confirm) {
    return {
      success: false,
      message: '请设置confirm为true以确认清理操作'
    };
  }

  const collections = [
    'users',
    'body_profile',
    'wardrobe',
    'tryon_records',
    'inspirations',
    'tryon_tasks'
  ];

  const results = {};

  for (const collection of collections) {
    try {
      const res = await db.collection(collection)
        .where({
          openid: /^test-/
        })
        .remove();
      
      results[collection] = {
        success: true,
        count: res.stats.removed
      };
    } catch (error) {
      results[collection] = {
        success: false,
        error: error.message
      };
    }
  }

  return {
    success: true,
    results
  };
};
```

### 使用方法

1. 部署`cleanDatabase`云函数
2. 调用云函数，传入参数：
   ```json
   {
     "confirm": true
   }
   ```
3. 系统将删除所有OpenID以"test-"开头的测试数据

---

## 八、数据备份与恢复

### 备份数据

创建`backupDatabase`云函数：

```javascript
const cloud = require('wx-server-sdk');
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  const collections = [
    'users',
    'body_profile',
    'wardrobe',
    'tryon_records',
    'inspirations'
  ];

  const backup = {};

  for (const collection of collections) {
    const res = await db.collection(collection).get();
    backup[collection] = res.data;
  }

  const backupId = Date.now();
  const backupPath = `backups/backup-${backupId}.json`;

  await cloud.uploadFile({
    cloudPath: backupPath,
    fileContent: JSON.stringify(backup)
  });

  return {
    success: true,
    backupId,
    backupPath
  };
};
```

### 恢复数据

创建`restoreDatabase`云函数：

```javascript
const cloud = require('wx-server-sdk');
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();

exports.main = async (event, context) => {
  const { backupPath } = event;
  
  const fileRes = await cloud.downloadFile({
    fileID: backupPath
  });
  
  const backup = JSON.parse(fileRes.fileContent.toString());
  
  const results = {};
  
  for (const [collection, data] of Object.entries(backup)) {
    for (const record of data) {
      const { _id, ...recordData } = record;
      await db.collection(collection).add({
        data: recordData
      });
    }
    results[collection] = {
      success: true,
      count: data.length
    };
  }
  
  return {
    success: true,
    results
  };
};
```

---

## 九、检查清单

完成数据库初始化后，请确认：

- [ ] users集合已创建索引
- [ ] body_profile集合已创建索引
- [ ] wardrobe集合已创建索引
- [ ] tryon_records集合已创建索引
- [ ] inspirations集合已创建索引
- [ ] tryon_tasks集合已创建索引
- [ ] 测试用户数据已创建（可选）
- [ ] 测试服装数据已创建（可选）
- [ ] 官方灵感数据已导入（详见官方灵感数据初始化指南）

---

## 十、注意事项

1. **数据安全**
   - 生产环境不要使用测试数据
   - 定期备份数据
   - 设置合理的数据库权限

2. **性能优化**
   - 合理创建索引
   - 避免大量数据一次性查询
   - 使用分页查询

3. **数据一致性**
   - 使用事务处理关键操作
   - 设置合理的更新策略
   - 定期清理过期数据

---

**操作记录时间**：请在此记录完成时间
**操作人员**：请在此记录操作人员
**备注**：请在此记录遇到的问题和解决方案