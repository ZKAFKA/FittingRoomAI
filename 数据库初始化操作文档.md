# 数据库初始化操作文档

## 概述

本文档详细说明如何在微信开发者工具中执行数据库初始化操作，包括云函数部署、数据库集合创建、数据导入等步骤。

---

## 一、前置准备

### 1.1 打开项目

1. 打开微信开发者工具
2. 点击"导入项目"
3. 选择项目目录：`c:\Users\ZKAFKA\Desktop\FittingRoomAI+`
4. 输入AppID（如果没有，选择"测试号"）
5. 点击"导入"

### 1.2 开通云开发

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"开通云开发"
3. 选择"按量付费"或"包年包月"套餐
4. 点击"开通"
5. 等待云开发环境创建完成（约1-2分钟）

### 1.3 记录环境ID

1. 云开发开通后，在云开发控制台首页
2. 找到"环境ID"（格式：`cloud1-xxx` 或 `fittingroom-prod-xxx`）
3. 复制环境ID
4. 打开项目中的 [app.js](file:///c:/Users/ZKAFKA/Desktop/FittingRoomAI+/app.js#L23) 文件
5. 将环境ID更新到以下位置：
   ```javascript
   cloud.init({
     env: 'your-env-id'  // 替换为您的环境ID
   });
   ```

---

## 二、创建数据库集合

### 2.1 打开数据库管理

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"数据库"
3. 进入数据库管理界面

### 2.2 创建集合

按照以下顺序创建6个数据库集合：

#### 2.2.1 创建users集合

1. 点击"添加集合"
2. 集合名称：`users`
3. 权限设置：选择"所有用户可读，仅创建者可写"
4. 点击"确定"

#### 2.2.2 创建body_profile集合

1. 点击"添加集合"
2. 集合名称：`body_profile`
3. 权限设置：选择"所有用户可读，仅创建者可写"
4. 点击"确定"

#### 2.2.3 创建wardrobe集合

1. 点击"添加集合"
2. 集合名称：`wardrobe`
3. 权限设置：选择"所有用户可读，仅创建者可写"
4. 点击"确定"

#### 2.2.4 创建tryon_records集合

1. 点击"添加集合"
2. 集合名称：`tryon_records`
3. 权限设置：选择"所有用户可读，仅创建者可写"
4. 点击"确定"

#### 2.2.5 创建inspirations集合

1. 点击"添加集合"
2. 集合名称：`inspirations`
3. 权限设置：选择"所有用户可读，仅创建者可写"
4. 点击"确定"

#### 2.2.6 创建tryon_tasks集合

1. 点击"添加集合"
2. 集合名称：`tryon_tasks`
3. 权限设置：选择"所有用户可读，仅创建者可写"
4. 点击"确定"

### 2.3 创建数据库索引

为提高查询性能，需要为以下字段创建索引：

#### 2.3.1 users集合索引

1. 点击`users`集合
2. 点击"索引管理"
3. 点击"添加索引"
4. 索引名称：`openid_index`
5. 索引字段：`openid`
6. 索引类型：`升序`
7. 点击"确定"

#### 2.3.2 wardrobe集合索引

1. 点击`wardrobe`集合
2. 点击"索引管理"
3. 点击"添加索引"
4. 索引名称：`openid_category_index`
5. 索引字段：`openid`（升序）、`category`（升序）
6. 点击"确定"

#### 2.3.3 tryon_records集合索引

1. 点击`tryon_records`集合
2. 点击"索引管理"
3. 点击"添加索引"
4. 索引名称：`openid_createTime_index`
5. 索引字段：`openid`（升序）、`createTime`（降序）
6. 点击"确定"

#### 2.3.4 inspirations集合索引

1. 点击`inspirations`集合
2. 点击"索引管理"
3. 点击"添加索引"
4. 索引名称：`isOfficial_createTime_index`
5. 索引字段：`isOfficial`（升序）、`createTime`（降序）
6. 点击"确定"

---

## 三、初始化云存储

### 3.1 创建目录结构

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"存储"
3. 点击"新建文件夹"
4. 文件夹名称：`inspirations`
5. 进入`inspirations`文件夹
6. 创建子文件夹：`official`
7. 返回根目录
8. 创建文件夹：`clothes`
9. 创建文件夹：`user-photos`
10. 创建文件夹：`tryon-results`
11. 创建文件夹：`backups`

### 3.2 上传资源文件

**注意**：以下资源文件需要您自行准备或使用占位符图片。

#### 3.2.1 上传官方灵感图片

1. 进入`inspirations/official`文件夹
2. 点击"上传文件"
3. 选择准备好的官方灵感图片（8张）
4. 图片命名规范：
   - `inspiration-001-casual.jpg`
   - `inspiration-002-business.jpg`
   - `inspiration-003-sport.jpg`
   - `inspiration-004-fashion.jpg`
   - `inspiration-005-minimalist.jpg`
   - `inspiration-006-vintage.jpg`
   - `inspiration-007-street.jpg`
   - `inspiration-008-formal.jpg`
5. 点击"确定"
6. 等待上传完成

#### 3.2.2 上传服装图片

1. 进入`clothes`文件夹
2. 点击"上传文件"
3. 选择准备好的服装图片
4. 图片命名规范：
   - `white-tshirt.jpg`
   - `black-tshirt.jpg`
   - `blue-shirt.jpg`
   - `black-jeans.jpg`
   - `blue-jeans.jpg`
   - `black-dress-pants.jpg`
   - `white-sneakers.jpg`
   - `black-sneakers.jpg`
   - `black-leather-shoes.jpg`
   - `black-cap.jpg`
   - `white-cap.jpg`
   - `black-backpack.jpg`
5. 点击"确定"
6. 等待上传完成

---

## 四、部署云函数

### 4.1 部署login云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/login`文件夹
2. 右键点击`login`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

### 4.2 部署generateImage-wndKh7云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/generateImage-wndKh7`文件夹
2. 右键点击`generateImage-wndKh7`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

### 4.3 部署initInspirations云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/initInspirations`文件夹
2. 右键点击`initInspirations`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

### 4.4 部署initWardrobe云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/initWardrobe`文件夹
2. 右键点击`initWardrobe`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

### 4.5 部署cleanDatabase云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/cleanDatabase`文件夹
2. 右键点击`cleanDatabase`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

### 4.6 部署backupDatabase云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/backupDatabase`文件夹
2. 右键点击`backupDatabase`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

### 4.7 部署restoreDatabase云函数

1. 在微信开发者工具中，找到左侧目录树中的`cloudfunctions/restoreDatabase`文件夹
2. 右键点击`restoreDatabase`文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）
5. 部署成功后，会显示"上传成功"

---

## 五、初始化官方灵感数据

### 5.1 更新图片URL

**重要**：在执行初始化之前，需要更新`initInspirations`云函数中的图片URL。

1. 打开 [cloudfunctions/initInspirations/index.js](file:///c:/Users/ZKAFKA/Desktop/FittingRoomAI+/cloudfunctions/initInspirations/index.js)
2. 找到所有`imageUrl`字段
3. 将`cloud://fittingroom-prod-xxxxx`替换为您的实际云存储环境ID
4. 保存文件
5. 重新部署`initInspirations`云函数（右键 → 上传并部署）

### 5.2 执行初始化

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"云函数"
3. 找到`initInspirations`云函数
4. 点击"测试"按钮
5. 点击"调用"按钮
6. 查看返回结果：
   ```json
   {
     "success": true,
     "total": 8,
     "successCount": 8,
     "failCount": 0,
     "results": [...]
   }
   ```

### 5.3 验证数据

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"数据库"
3. 点击`inspirations`集合
4. 查看是否成功插入了8条官方灵感数据
5. 确认`isOfficial`字段为`true`
6. 确认图片URL正确

---

## 六、初始化测试服装数据（可选）

### 6.1 获取用户OpenID

1. 在微信开发者工具中，点击"编译"按钮
2. 在模拟器中打开小程序
3. 打开调试器（F12）
4. 在Console中输入：`wx.cloud.getWXContext()`
5. 记录返回的`OPENID`

### 6.2 执行初始化

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"云函数"
3. 找到`initWardrobe`云函数
4. 点击"测试"按钮
5. 输入测试参数：
   ```json
   {
     "openid": "your-openid-here"
   }
   ```
6. 点击"调用"按钮
7. 查看返回结果：
   ```json
   {
     "success": true,
     "total": 12,
     "successCount": 12,
     "failCount": 0,
     "results": [...]
   }
   ```

### 6.3 验证数据

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"数据库"
3. 点击`wardrobe`集合
4. 查看是否成功插入了12条测试服装数据

---

## 七、测试云函数

### 7.1 测试login云函数

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"云函数"
3. 找到`login`云函数
4. 点击"测试"按钮
5. 点击"调用"按钮
6. 查看返回结果：
   ```json
   {
     "success": true,
     "openid": "oxxxxx",
     "sessionKey": "xxxxx"
   }
   ```

### 7.2 测试generateImage-wndKh7云函数

**注意**：此云函数需要HunyuanImage API配置，暂时无法直接测试。

---

## 八、数据备份与恢复

### 8.1 备份数据库

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"云函数"
3. 找到`backupDatabase`云函数
4. 点击"测试"按钮
5. 点击"调用"按钮
6. 查看返回结果，记录`backupPath`
7. 备份文件已保存到云存储的`backups`目录

### 8.2 恢复数据库

**警告**：恢复操作会覆盖现有数据，请谨慎操作。

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"云函数"
3. 找到`restoreDatabase`云函数
4. 点击"测试"按钮
5. 输入测试参数：
   ```json
   {
     "backupPath": "cloud://your-env-id/backups/backup-xxx.json"
   }
   ```
6. 点击"调用"按钮
7. 查看返回结果

### 8.3 清理测试数据

1. 在微信开发者工具中，点击顶部菜单"云开发"
2. 点击"云函数"
3. 找到`cleanDatabase`云函数
4. 点击"测试"按钮
5. 输入测试参数：
   ```json
   {
     "confirm": true
   }
   ```
6. 点击"调用"按钮
7. 查看返回结果

---

## 九、检查清单

完成数据库初始化后，请确认：

### 9.1 云开发环境

- [ ] 云开发已开通
- [ ] 环境ID已记录并更新到app.js
- [ ] 云存储目录结构已创建

### 9.2 数据库集合

- [ ] users集合已创建
- [ ] body_profile集合已创建
- [ ] wardrobe集合已创建
- [ ] tryon_records集合已创建
- [ ] inspirations集合已创建
- [ ] tryon_tasks集合已创建

### 9.3 数据库索引

- [ ] users集合索引已创建
- [ ] wardrobe集合索引已创建
- [ ] tryon_records集合索引已创建
- [ ] inspirations集合索引已创建

### 9.4 云函数

- [ ] login云函数已部署
- [ ] generateImage-wndKh7云函数已部署
- [ ] initInspirations云函数已部署
- [ ] initWardrobe云函数已部署
- [ ] cleanDatabase云函数已部署
- [ ] backupDatabase云函数已部署
- [ ] restoreDatabase云函数已部署

### 9.5 数据

- [ ] 官方灵感图片已上传
- [ ] 服装图片已上传
- [ ] 官方灵感数据已初始化
- [ ] 测试服装数据已初始化（可选）

### 9.6 测试

- [ ] login云函数测试通过
- [ ] initInspirations云函数测试通过
- [ ] initWardrobe云函数测试通过（可选）

---

## 十、常见问题

### 10.1 云函数部署失败

**问题**：云函数部署时提示"上传失败"

**解决方案**：
1. 检查网络连接
2. 确认云开发环境已开通
3. 检查云函数代码是否有语法错误
4. 尝试重新部署

### 10.2 数据库集合创建失败

**问题**：创建数据库集合时提示"集合已存在"

**解决方案**：
1. 这是正常情况，说明集合已经存在
2. 可以跳过该集合的创建步骤
3. 继续创建其他集合

### 10.3 图片上传失败

**问题**：上传图片时提示"文件过大"

**解决方案**：
1. 压缩图片大小
2. 确保单张图片不超过2MB
3. 使用WebP格式减小文件大小

### 10.4 云函数调用失败

**问题**：调用云函数时提示"云函数不存在"

**解决方案**：
1. 确认云函数已成功部署
2. 检查云函数名称是否正确
3. 重新部署云函数

### 10.5 数据初始化失败

**问题**：调用initInspirations云函数时提示"图片URL错误"

**解决方案**：
1. 确认图片已成功上传到云存储
2. 检查图片URL是否正确
3. 确认环境ID是否正确
4. 更新云函数中的图片URL并重新部署

---

## 十一、后续操作

完成数据库初始化后，可以进行以下操作：

1. **开发小程序页面**
   - 完善各个页面的功能
   - 实现与云函数的交互
   - 优化用户体验

2. **配置HunyuanImage API**
   - 申请HunyuanImage API密钥
   - 配置generateImage-wndKh7云函数
   - 测试图像生成功能

3. **测试完整流程**
   - 测试用户登录
   - 测试服装上传
   - 测试虚拟试衣
   - 测试灵感分享

4. **发布上线**
   - 提交审核
   - 发布小程序
   - 监控运行状态

---

**操作记录时间**：请在此记录完成时间
**操作人员**：请在此记录操作人员
**环境ID**：请在此记录您的云开发环境ID
**备注**：请在此记录遇到的问题和解决方案