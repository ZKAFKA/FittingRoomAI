# 第二步：初始化云开发（预计耗时：1小时）

## 概述

本步骤将完成微信云开发服务的初始化，包括开通服务、创建数据库集合、配置云函数等核心操作。

---

## 一、开通云开发服务

### 操作步骤

1. **打开微信开发者工具**
   - 启动微信开发者工具
   - 使用微信扫码登录
   - 点击"导入项目"
   - 选择项目目录：`c:\Users\ZKAFKA\Desktop\FittingRoomAI+`
   - AppID选择"测试号"或填入正式AppID
   - 点击"导入"

2. **开通云开发**
   - 在微信开发者工具中，点击顶部工具栏的"云开发"按钮
   - 阅读并同意《微信云开发服务协议》
   - 填写环境信息：
     - 环境名称：`fittingroom-prod`
     - 基础库版本：选择最新版本
   - 选择套餐：
     - 免费版：适合开发测试（每月免费额度）
     - 付费版：适合生产环境
   - 点击"开通"按钮
   - 等待环境创建完成（约1-2分钟）

3. **记录环境信息**
   - 开通成功后，会显示环境ID（Environment ID）
   - 格式类似：`fittingroom-prod-xxxxx`
   - **重要操作**：将环境ID记录到安全位置

4. **更新项目配置**
   - 打开文件：`app.js`
   - 找到第23行的环境配置：
     ```javascript
     env: 'your-env-id'
     ```
   - 替换为实际的环境ID：
     ```javascript
     env: 'fittingroom-prod-xxxxx'
     ```
   - 保存文件

---

## 二、创建数据库集合

### 操作步骤

1. **打开云开发控制台**
   - 在微信开发者工具中，点击"云开发"按钮
   - 选择"数据库"标签

2. **创建users集合（用户信息）**
   - 点击"添加集合"
   - 集合名称：`users`
   - 权限设置：选择"自定义"
   - 权限配置（JSON格式）：
     ```json
     {
       "read": "doc.openid == auth.openid",
       "write": "doc.openid == auth.openid"
     }
     ```
   - 点击"确定"

3. **创建body_profile集合（身体档案）**
   - 集合名称：`body_profile`
   - 权限配置：同users集合
   - 点击"确定"

4. **创建wardrobe集合（服装库）**
   - 集合名称：`wardrobe`
   - 权限配置：同users集合
   - 点击"确定"

5. **创建tryon_records集合（试衣记录）**
   - 集合名称：`tryon_records`
   - 权限配置：同users集合
   - 点击"确定"

6. **创建inspirations集合（灵感库）**
   - 集合名称：`inspirations`
   - 权限设置：选择"自定义"
   - 权限配置（JSON格式）：
     ```json
     {
       "read": true,
       "write": "doc.openid == auth.openid"
     }
     ```
   - 点击"确定"
   - **说明**：此集合允许所有用户读取，但只有创建者可以写入

7. **创建tryon_tasks集合（试衣任务队列）**
   - 集合名称：`tryon_tasks`
   - 权限配置：同users集合
   - 点击"确定"

---

## 三、创建数据库索引

### 操作步骤

对每个集合创建以下索引：

#### users集合索引
1. 点击"users"集合
2. 点击"索引管理"
3. 添加索引：
   - 索引名称：`openid`
   - 索引字段：`openid`
   - 索引类型：唯一索引
   - 点击"创建"

#### body_profile集合索引
1. 点击"body_profile"集合
2. 点击"索引管理"
3. 添加索引：
   - 索引名称：`openid`
   - 索引字段：`openid`
   - 索引类型：普通索引
   - 点击"创建"

#### wardrobe集合索引
1. 点击"wardrobe"集合
2. 点击"索引管理"
3. 添加索引：
   - 索引名称：`openid_category`
   - 索引字段：`openid`, `category`
   - 索引类型：复合索引
   - 点击"创建"
4. 添加索引：
   - 索引名称：`createTime`
   - 索引字段：`createTime`
   - 索引类型：普通索引
   - 点击"创建"
5. 添加索引：
   - 索引名称：`usageCount`
   - 索引字段：`usageCount`
   - 索引类型：普通索引
   - 点击"创建"

#### tryon_records集合索引
1. 点击"tryon_records"集合
2. 点击"索引管理"
3. 添加索引：
   - 索引名称：`openid_createTime`
   - 索引字段：`openid`, `createTime`
   - 索引类型：复合索引
   - 点击"创建"
4. 添加索引：
   - 索引名称：`createTime`
   - 索引字段：`createTime`
   - 索引类型：普通索引
   - 点击"创建"

#### inspirations集合索引
1. 点击"inspirations"集合
2. 点击"索引管理"
3. 添加索引：
   - 索引名称：`createTime`
   - 索引字段：`createTime`
   - 索引类型：普通索引
   - 点击"创建"
4. 添加索引：
   - 索引名称：`likes`
   - 索引字段：`likes`
   - 索引类型：普通索引
   - 点击"创建"
5. 添加索引：
   - 索引名称：`style`
   - 索引字段：`style`
   - 索引类型：普通索引
   - 点击"创建"
6. 添加索引：
   - 索引名称：`isOfficial_status`
   - 索引字段：`isOfficial`, `status`
   - 索引类型：复合索引
   - 点击"创建"

#### tryon_tasks集合索引
1. 点击"tryon_tasks"集合
2. 点击"索引管理"
3. 添加索引：
   - 索引名称：`openid_createTime`
   - 索引字段：`openid`, `createTime`
   - 索引类型：复合索引
   - 点击"创建"
4. 添加索引：
   - 索引名称：`status`
   - 索引字段：`status`
   - 索引类型：普通索引
   - 点击"创建"

---

## 四、初始化云存储目录

### 操作步骤

1. **打开云存储**
   - 在云开发控制台，选择"存储"标签

2. **创建目录结构**
   - 点击"新建文件夹"
   - 创建以下目录：
     - `users/` - 用户相关文件
     - `users/avatars/` - 用户头像
     - `users/photos/` - 用户上传的照片
     - `wardrobe/` - 服装库
     - `wardrobe/originals/` - 原始上传图片
     - `wardrobe/processed/` - 处理后的图片
     - `tryon-results/` - 试衣结果
     - `inspirations/` - 灵感库

---

## 五、配置云函数

### 操作步骤

1. **打开云函数管理**
   - 在云开发控制台，选择"云函数"标签

2. **创建login云函数**
   - 点击"新建云函数"
   - 函数名称：`login`
   - 运行环境：Node.js 16.x
   - 点击"下一步"
   - 创建以下文件：
     - `index.js` - 函数主文件
     - `package.json` - 依赖配置
   - 复制以下代码到`index.js`：
     ```javascript
     const cloud = require('wx-server-sdk');
     cloud.init({
       env: cloud.DYNAMIC_CURRENT_ENV
     });

     const db = cloud.database();
     const _ = db.command;

     exports.main = async (event, context) => {
       const { OPENID } = cloud.getWXContext();
       
       const userRes = await db.collection('users')
         .where({ openid: OPENID })
         .get();
       
       if (userRes.data.length === 0) {
         await db.collection('users').add({
           data: {
             openid: OPENID,
             nickName: '用户',
             avatarUrl: '/assets/images/default-avatar.png',
             createTime: db.serverDate(),
             updateTime: db.serverDate(),
             settings: {
               privacyProtection: false,
               backgroundReplace: false,
               imageOptimization: false
             },
             stats: {
               totalTryOn: 0,
               totalShares: 0,
               totalLikes: 0
             }
           }
         });
       }
       
       return {
         openid: OPENID,
         sessionKey: cloud.getWXContext().SESSIONKEY
       };
     };
     ```
   - 复制以下代码到`package.json`：
     ```json
     {
       "name": "login",
       "version": "1.0.0",
       "description": "用户登录云函数",
       "main": "index.js",
       "dependencies": {
         "wx-server-sdk": "~2.6.3"
       }
     }
     ```
   - 点击"上传并部署：云端安装依赖"

3. **验证login云函数**
   - 点击"测试"按钮
   - 点击"调用"按钮
   - 查看返回结果：
     ```json
     {
       "openid": "oxxxxx",
       "sessionKey": "xxxxx"
     }
     ```
   - 如果返回成功，说明云函数配置正确

---

## 六、创建generateImage-wndKh7云函数

### 操作步骤

**注意**：此云函数是核心功能，需要调用HunyuanImage 3.0 API。

1. **创建云函数**
   - 点击"新建云函数"
   - 函数名称：`generateImage-wndKh7`
   - 运行环境：Node.js 16.x
   - 点击"下一步"

2. **创建函数文件**
   - 创建`index.js`文件
   - 复制以下代码：
     ```javascript
     const cloud = require('wx-server-sdk');
     cloud.init({
       env: cloud.DYNAMIC_CURRENT_ENV
     });

     const db = cloud.database();
     const _ = db.command;

     exports.main = async (event, context) => {
       const { 
         userImage, 
         clothes, 
         prompt, 
         mode, 
         settings,
         bodyProfile 
       } = event;
       
       const openid = cloud.getWXContext().OPENID;
       
       try {
         const startTime = Date.now();
         
         const result = await callHunyuanAPI({
           userImage,
           clothes,
           prompt,
           mode,
           settings,
           bodyProfile
         });
         
         const duration = (Date.now() - startTime) / 1000;
         
         await saveTryonRecord({
           openid,
           userImage,
           resultImage: result.url,
           clothes,
           prompt,
           mode,
           settings,
           bodyProfile,
           duration
         });
         
         return {
           success: true,
           resultUrl: result.url,
           duration
         };
       } catch (error) {
         console.error('生成失败:', error);
         return {
           success: false,
           error: error.message
         };
       }
     };

     async function callHunyuanAPI(params) {
       const { userImage, clothes, prompt, mode, settings, bodyProfile } = params;
       
       const hunyuanPrompt = buildHunyuanPrompt({
         userImage,
         clothes,
         prompt,
         mode,
         settings,
         bodyProfile
       });
       
       const result = await cloud.callFunction({
         name: 'hunyuan-image-api',
         data: {
           prompt: hunyuanPrompt,
           referenceImage: userImage,
           mode: mode === 'change' ? 'image-to-image' : 'text-to-image',
           num_inference_steps: settings.imageOptimization ? 30 : 20,
           guidance_scale: 7.5
         }
       });
       
       return {
         url: result.result.image_url
       };
     }

     function buildHunyuanPrompt(params) {
       const { userImage, clothes, prompt, mode, settings, bodyProfile } = params;
       
       let hunyuanPrompt = '';
       
       if (mode === 'change') {
         hunyuanPrompt = `Image-to-Image generation task. Reference the provided user photo and replace the clothing with ${clothes[0].name}. 
         
     CRITICAL REQUIREMENTS:
     1. Keep the person's facial features EXACTLY the same - no changes to face, eyes, nose, mouth, or expression
     2. Maintain the person's body shape, height, and weight proportions
     3. Only replace the clothing item, do not modify the person's physical characteristics
     4. The new clothing should fit naturally and realistically on the person
     5. Preserve the original lighting and atmosphere
     6. Ensure the clothing drapes and folds naturally according to the person's body

     ${bodyProfile.height ? `Body reference: ${bodyProfile.height}cm, ${bodyProfile.weight}kg` : ''}

     ${settings.privacyProtection ? 'Add a subtle blur effect to the background while keeping the person sharp and clear.' : ''}
     ${settings.backgroundReplace ? 'Replace the background with a suitable scene that complements the clothing style.' : ''}
     ${settings.imageOptimization ? 'Apply additional optimization to enhance realism and remove any artifacts.' : ''}`;
       } else {
         const clothingList = clothes.map(c => c.name).join(', ');
         hunyuanPrompt = `Image-to-Image generation task. Reference the provided user photo and dress them in the following clothing items: ${clothingList}.
         
     CRITICAL REQUIREMENTS:
     1. Keep the person's facial features EXACTLY the same - no changes to face, eyes, nose, mouth, or expression
     2. Maintain the person's body shape, height, and weight proportions
     3. Layer the clothing items appropriately to create a natural, coordinated outfit
     4. Ensure each garment fits properly and drapes naturally on the person's body
     5. Preserve the original lighting and atmosphere
     6. The outfit should look cohesive and stylish

     Clothing details:
     - ${clothes.map(c => `${c.category}: ${c.name} - ${c.color}, ${c.style}`).join('\n- ')}

     ${bodyProfile.height ? `Body reference: ${bodyProfile.height}cm, ${bodyProfile.weight}kg` : ''}

     ${settings.privacyProtection ? 'Add a subtle blur effect to the background while keeping the person sharp and clear.' : ''}
     ${settings.backgroundReplace ? 'Replace the background with a suitable scene that complements the clothing style.' : ''}
     ${settings.imageOptimization ? 'Apply additional optimization to enhance realism and remove any artifacts.' : ''}`;
       }
       
       return hunyuanPrompt;
     }

     async function saveTryonRecord(params) {
       const {
         openid,
         userImage,
         resultImage,
         clothes,
         prompt,
         mode,
         settings,
         bodyProfile,
         duration
       } = params;
       
       await db.collection('tryon_records').add({
         data: {
           openid,
           userImageUrl: userImage,
           resultImageUrl: resultImage,
           tryonMode: mode,
           selectedClothes: clothes,
           prompt,
           settings,
           bodyProfile,
           generationTime: duration,
           aiOptimized: settings.imageOptimization,
           createTime: db.serverDate(),
           isShared: false
         }
       });
     }
     ```
   - 创建`package.json`文件：
     ```json
     {
       "name": "generateImage-wndKh7",
       "version": "1.0.0",
       "description": "试衣图像生成云函数",
       "main": "index.js",
       "dependencies": {
         "wx-server-sdk": "~2.6.3"
       }
     }
     ```
   - 点击"上传并部署：云端安装依赖"

3. **验证云函数**
   - 点击"测试"按钮
   - 输入测试参数：
     ```json
     {
       "userImage": "cloud://xxx/user.jpg",
       "clothes": [
         {
           "name": "白色T恤",
           "category": "upper",
           "color": "white",
           "style": "casual"
         }
       ],
       "prompt": "Replace the person's clothing with a white t-shirt",
       "mode": "change",
       "settings": {
         "privacyProtection": false,
         "backgroundReplace": false,
         "imageOptimization": false
       },
       "bodyProfile": {
         "height": 170,
         "weight": 65
       }
     }
     ```
   - 点击"调用"按钮
   - 查看返回结果

---

## 七、检查清单

完成本步骤后，请确认以下项目：

- [ ] 云开发环境已开通
- [ ] 环境ID已记录并更新到app.js
- [ ] 6个数据库集合已创建
- [ ] 所有索引已创建
- [ ] 云存储目录结构已创建
- [ ] login云函数已创建并测试通过
- [ ] generateImage-wndKh7云函数已创建并测试通过

---

## 八、常见问题

### Q1: 云开发开通失败怎么办？
**A**: 检查以下项目：
- 微信账号是否有权限开通云开发
- 网络连接是否正常
- 是否选择了正确的AppID

### Q2: 数据库集合创建失败怎么办？
**A**: 检查以下项目：
- 集合名称是否正确（不能包含特殊字符）
- 权限配置JSON格式是否正确
- 云开发环境是否正常运行

### Q3: 云函数部署失败怎么办？
**A**: 检查以下项目：
- 代码语法是否正确
- package.json格式是否正确
- 依赖包版本是否兼容
- 运行环境版本是否正确

### Q4: 环境ID在哪里查看？
**A**: 
- 方法1：在云开发控制台首页查看
- 方法2：在云函数管理页面查看
- 方法3：在数据库管理页面查看

---

## 九、下一步

完成本步骤后，继续执行：
- **第三步**：初始化官方灵感库数据
- **第四步**：准备图标和图片资源
- **第五步**：测试小程序基础功能

---

**操作记录时间**：请在此记录完成时间
**操作人员**：请在此记录操作人员
**备注**：请在此记录遇到的问题和解决方案